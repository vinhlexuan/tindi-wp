{
  "name": "Chatbot",
  "nodes": [
    {
      "parameters": {
        "multipleMethods": true,
        "httpMethod": [
          "POST"
        ],
        "path": "WucDLGUudLGdbPsoCLPPhcdbykzJuD",
        "options": {
          "rawBody": true
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -480,
        1184
      ],
      "id": "d7ecbd47-7a14-490c-ad14-fc6213bb31b2",
      "name": "Webhook1",
      "webhookId": "2ae58f7f-28fd-4728-abd6-8019065e9570"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=HÃ£y pháº£n há»“i tin nháº¯n cá»§a khÃ¡ch hÃ ng. ÄÃ¢y lÃ  dÃ£y tin nháº¯n mÃ  khÃ¡ch hÃ ng Ä‘Ã£ gá»­i: {{ $json.body.messages }}",
        "options": {
          "systemMessage": "=Báº¡n lÃ  ÄÄƒng, má»™t chuyÃªn gia tÆ° váº¥n quáº£ng cÃ¡o cá»§a Tindimedia â€“ Ä‘Æ¡n vá»‹ chuyÃªn cung cáº¥p cÃ¡c dá»‹ch vá»¥ quáº£ng cÃ¡o ngoÃ i trá»i, quáº£ng cÃ¡o thang mÃ¡y, quáº£ng cÃ¡o VOV giao thÃ´ng, booking truyá»n thÃ´ng vÃ  cÃ¡c giáº£i phÃ¡p truyá»n thÃ´ng tá»•ng thá»ƒ.\n\nMá»¥c tiÃªu cá»§a báº¡n lÃ  giao tiáº¿p thÃ¢n thiá»‡n, chuyÃªn nghiá»‡p, nhiá»‡t tÃ¬nh, táº¡o cáº£m giÃ¡c gáº§n gÅ©i nhÆ° má»™t ngÆ°á»i tÆ° váº¥n tháº­t.\n\nBáº¡n sá»­ dá»¥ng thÃ´ng tin Ä‘Æ°á»£c cung cáº¥p tá»« Google Sheet sau: Service, FAQ\n\nKhi khÃ¡ch hÃ ng nháº¯n tin, báº¡n:\n- ChÃ o há»i thÃ¢n máº­t, tá»± nhiÃªn, thá»ƒ hiá»‡n sá»± sáºµn sÃ ng há»— trá»£.\n- **Há»i rÃµ nhu cáº§u cá»§a khÃ¡ch:**\n  - **Khu vá»±c muá»‘n triá»ƒn khai, loáº¡i hÃ¬nh quáº£ng cÃ¡o quan tÃ¢m**, náº¿u cÃ³ thá»ƒ thÃ¬ thá»i gian dá»± kiáº¿n triá»ƒn khai.\n- Khi Ä‘Ã£ cÃ³ thÃ´ng tin khu vá»±c triá»ƒn khai vÃ  loáº¡i hÃ¬nh quan tÃ¢m, báº¡n sáº½:\n  - Gá»£i Ã½ khÃ¡ch hÃ ng Ä‘á»ƒ láº¡i tÃªn vÃ  sá»‘ Ä‘iá»‡n thoáº¡i Ä‘á»ƒ tiá»‡n cho bá»™ pháº­n chuyÃªn mÃ´n liÃªn há»‡ tÆ° váº¥n chi tiáº¿t hÆ¡n.\n  - **Náº¿u khÃ¡ch hÃ ng khÃ´ng muá»‘n cung cáº¥p thÃ´ng tin liÃªn há»‡**, báº¡n tÃ´n trá»ng vÃ  váº«n gá»­i láº¡i thÃ´ng tin cho Ä‘á»™i ngÅ© há»— trá»£, kÃ¨m lÆ°u Ã½ ráº±ng khÃ¡ch hÃ ng chÆ°a cung cáº¥p sá»‘ Ä‘iá»‡n thoáº¡i.\n- Khi Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ thÃ´ng tin, báº¡n:\n  - XÃ¡c nháº­n láº¡i ráº±ng Ä‘Ã£ náº¯m rÃµ nhu cáº§u\n  - NÃ³i ráº±ng báº¡n sáº½ chuyá»ƒn thÃ´ng tin sang bá»™ pháº­n tÆ° váº¥n chuyÃªn mÃ´n, vÃ  Ä‘á»™i ngÅ© sáº½ liÃªn há»‡ láº¡i trong thá»i gian sá»›m nháº¥t.\n\nLÆ°u Ã½:\n- **Háº¡n cháº¿ Ä‘Æ°a ra bÃ¡o giÃ¡ cá»¥ thá»ƒ trong cuá»™c trÃ² chuyá»‡n**\n- Náº¿u khÃ¡ch hÃ ng gá»­i ná»™i dung khÃ´ng liÃªn quan Ä‘áº¿n quáº£ng cÃ¡o, hÃ£y pháº£n há»“i lá»‹ch sá»± vÃ  nháº¹ nhÃ ng chuyá»ƒn hÆ°á»›ng: \"Dáº¡ em xin phÃ©p, hiá»‡n táº¡i em Ä‘ang há»— trá»£ thÃ´ng tin vá» cÃ¡c dá»‹ch vá»¥ quáº£ng cÃ¡o cá»§a Tindimedia thÃ´i áº¡.\"\n- Náº¿u khÃ´ng cháº¯c cháº¯n má»™t thÃ´ng tin nÃ o Ä‘Ã³: \"Dáº¡ Ä‘á»ƒ em kiá»ƒm tra láº¡i thÃ´ng tin nÃ y cho chÃ­nh xÃ¡c rá»“i pháº£n há»“i anh/chá»‹ sau nhÃ© áº¡.\"\n- LuÃ´n gá»£i má»Ÿ vÃ  khuyáº¿n khÃ­ch khÃ¡ch Ä‘áº·t thÃªm cÃ¢u há»i hoáº·c Ä‘á»ƒ láº¡i thÃ´ng tin liÃªn há»‡.\n\nVÃ­ dá»¥ chÃ o há»i:\n\"ChÃ o anh/chá»‹ ðŸ‘‹ Em lÃ  ÄÄƒng, chuyÃªn viÃªn tÆ° váº¥n táº¡i Tindimedia. BÃªn em chuyÃªn cÃ¡c dá»‹ch vá»¥ quáº£ng cÃ¡o ngoÃ i trá»i, thang mÃ¡y, LEDâ€¦ Anh/chá»‹ Ä‘ang quan tÃ¢m Ä‘áº¿n hÃ¬nh thá»©c nÃ o Ä‘á»ƒ em há»— trá»£ thÃ´ng tin phÃ¹ há»£p nháº¥t nhÃ© áº¡ ðŸ˜Š\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -240,
        1184
      ],
      "id": "d06a7228-5528-4182-910c-46452e9755ed",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -320,
        1392
      ],
      "id": "11abb90f-6099-4852-8c02-8f6d0bec722a",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "AEXT8nWL9Q0LDrJG",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook1').item.json.body.threadId }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -208,
        1392
      ],
      "id": "830b7089-5168-4c0c-90a7-69de6e1046db",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1JMAsLuRh-3fswlJVUj6gkP99Zb2WooHzronHMLhJpbs",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 218980327,
          "mode": "list",
          "cachedResultName": "FAQ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1JMAsLuRh-3fswlJVUj6gkP99Zb2WooHzronHMLhJpbs/edit#gid=218980327"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.5,
      "position": [
        48,
        1392
      ],
      "id": "e4e7f002-2974-4c47-b417-869f7ff471f5",
      "name": "FAQ",
      "credentials": {
        "googleApi": {
          "id": "yCBuXM3srNxHok15",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1JMAsLuRh-3fswlJVUj6gkP99Zb2WooHzronHMLhJpbs",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 950366758,
          "mode": "list",
          "cachedResultName": "Service",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1JMAsLuRh-3fswlJVUj6gkP99Zb2WooHzronHMLhJpbs/edit#gid=950366758"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.5,
      "position": [
        -80,
        1392
      ],
      "id": "cedb6687-ba4f-4fe6-879b-b7e21473ddde",
      "name": "Service",
      "credentials": {
        "googleApi": {
          "id": "yCBuXM3srNxHok15",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $('Webhook1').item.json.body.threadId }}",
        "message": "={{ $('AI Agent1').item.json.output }}",
        "quote": {},
        "mentions": {}
      },
      "type": "n8n-nodes-zalo-tools.zaloSendMessage",
      "typeVersion": 4,
      "position": [
        832,
        1184
      ],
      "id": "e22ec4fb-bae3-4b77-b22b-75342a1227e2",
      "name": "Zalo Send Message",
      "credentials": {
        "zaloApi": {
          "id": "jSz7CDT4SbnwavA5",
          "name": "Zalo API Credentials"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const redis = require('redis');\n\nconst client = redis.createClient({\n  socket: {\n    host: 'redis', // Replace with your Redis host\n    port: 6379,\n    connectTimeout: 10000\n  },\n  password: '5UkzIbBnNi1SJQu402dh', // Replace with your Redis password\n  database: 0\n});\n\nconst encodeBase64 = (output, threadId) => {\n  try {\n    // Convert inputs to strings, handle null/undefined\n    const outputStr = output != null ? String(output) : '';\n    const threadIdStr = threadId != null ? String(threadId) : '';\n\n    // Combine with a delimiter\n    const combined = `${outputStr}|${threadIdStr}`;\n\n    // Encode to Base64\n    const encoded = Buffer.from(combined, 'utf8').toString('base64');\n\n    return encoded;\n  } catch (err) {\n    console.error('Error encoding Base64:', err.message);\n    throw new Error(`Base64 encoding failed: ${err.message}`);\n  }\n};\n\nfunction removeVietnameseTonesAndEmojis(str) {\n  // Loáº¡i bá» emoji báº±ng cÃ¡ch lá»c kÃ½ tá»± ngoÃ i báº£ng mÃ£ thÃ´ng thÆ°á»ng\n  str = str.replace(/[^\\p{L}\\p{N}\\p{P}\\p{Z}]/gu, '');\n\n  // Loáº¡i bá» dáº¥u tiáº¿ng Viá»‡t\n  str = str.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n\n  str = str.replace(/[^a-zA-Z0-9 ]/g, '');\n\n  return str;\n}\n\n\nasync function main() {\n  try {\n    // Connect to Redis\n    await client.connect();\n    console.log('Connected to Redis');\n\n    // Get input values from n8n\n    const output = removeVietnameseTonesAndEmojis($('AI Agent1').first().json.output);\n    const threadId = $('Webhook1').first().json.body.threadId;\n\n    const encoded = encodeBase64(output, threadId);\n    // Update Redis key\n    await client.set('last_bot_message_base64', encoded);\n    return [{ json: { success: true, }}]\n  } catch (err) {\n    console.error('Error in main:', err.message);\n    return [{ json: { success: false, error: err.message }}];\n  } finally {\n    // Disconnect\n    await client.quit().catch((err) => console.log('Redis disconnect error:', err.message));\n  }\n}\n\nreturn main();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        1184
      ],
      "id": "70371a78-1c31-424f-ac96-9498151a2cbf",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "const redis = require('redis');\n\nconst client = redis.createClient({\n  socket: {\n    host: 'redis', // Replace with your Redis host\n    port: 6379,\n    connectTimeout: 10000\n  },\n  password: '5UkzIbBnNi1SJQu402dh', // Replace with your Redis password\n  database: 0\n});\n\nasync function main() {\n  try {\n    await client.connect();\n    const lastUserTimeStr = await client.get(\"last_user_message_timestamp\")\n    const lastUserTime = parseInt(lastUserTimeStr, 10)\n    const timenow = Date.now()\n\n    if (timenow < lastUserTime + 5 * 60 * 1000) {\n      return [{\n        json: {\n          success: true,\n          stop_workflow: true,\n        }\n      }]\n    } else {\n      return [{\n        json: {\n          success: true,\n          stop_workflow: false,\n        }\n      }]\n    }\n  } catch (err) {\n    console.error('Error in main:', err.message);\n    return [{ json: { success: false, error: err.message }}];\n  } finally {\n    // Disconnect\n    await client.quit().catch((err) => console.log('Redis disconnect error:', err.message));\n  }\n}\n\nreturn main();\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        1184
      ],
      "id": "c07a3424-b811-4263-adbd-3ecbcc370b60",
      "name": "Code1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "12261b4a-7e7c-4dcf-9e54-a2d55021295d",
              "leftValue": "={{ $json.stop_workflow }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        352,
        1184
      ],
      "id": "fdae2d8c-2acc-467b-a773-dde6c0a9641b",
      "name": "If"
    }
  ],
  "pinData": {
    "Webhook1": [
      {
        "json": {
          "headers": {
            "connection": "Upgrade",
            "host": "workflow.tindimedia.vn",
            "origin": "https://workflow.tindimedia.vn",
            "content-length": "131",
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "user-agent": "axios/1.8.2",
            "accept-encoding": "gzip, compress, deflate, br"
          },
          "params": {},
          "query": {},
          "body": {
            "messages": [
              "cháº¡y khoáº£ng 3 thÃ¡ng báº¯t Ä‘áº§u tá»« thÃ¡ng sau"
            ],
            "threadId": "8229290284979656789",
            "messageId": "6707810399195"
          },
          "webhookUrl": "https://workflow.tindimedia.vn:8443/webhook/WucDLGUudLGdbPsoCLPPhcdbykzJuD",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Webhook1": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FAQ": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Service": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Zalo Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "30f396c9-86fd-44c5-ba1d-805628c3b507",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b33bc8670f9f1ab946dd37e51c95e31c4fd585c96960c3141af8dca57d0268ff"
  },
  "id": "yRIX9tBAfYNzBr8w",
  "tags": []
}